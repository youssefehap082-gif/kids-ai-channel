name: Daily YouTube Automation

on:
  schedule:
    - cron: '0 12 * * *'  # ÙŠÙˆÙ…ÙŠØ§Ù‹ Ø§Ù„Ø³Ø§Ø¹Ø© 12 Ø¸Ù‡Ø±Ø§Ù‹ UTC
  workflow_dispatch:  # ØªØ´ØºÙŠÙ„ ÙŠØ¯ÙˆÙŠ
    inputs:
      upload_type:
        description: 'Ù†ÙˆØ¹ Ø§Ù„Ø±ÙØ¹'
        required: true
        default: 'real'
        type: choice
        options:
        - 'real'
        - 'test'

jobs:
  generate-and-upload:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y ffmpeg
        sudo apt-get install -y python3-pip
        sudo apt-get install -y libimage-exiftool-perl
        python -m pip install --upgrade pip
        
    - name: Install Python dependencies
      run: |
        pip install -r requirements.txt
        pip install google-api-python-client google-auth-httplib2 google-auth-oauthlib
        pip install moviepy --upgrade
        pip install pillow --upgrade
        
    - name: Create necessary directories
      run: |
        mkdir -p logs outputs/videos outputs/shorts outputs/temp data assets/music scripts
        
    - name: Create basic data files
      run: |
        cat > data/animal_database.json << 'EOF'
        {
          "mammals": ["Lion", "Elephant", "Tiger", "Giraffe", "Wolf", "Bear", "Kangaroo", "Panda", "Zebra", "Fox", "Deer", "Horse", "Donkey", "Rabbit", "Raccoon"],
          "reptiles": ["Cobra", "Python", "Chameleon", "Komodo Dragon", "Alligator", "Turtle", "Crocodile", "Iguana", "Gecko", "Snake"],
          "birds": ["Eagle", "Parrot", "Penguin", "Owl", "Flamingo", "Peacock", "Hawk", "Swan", "Pigeon", "Sparrow"],
          "fish": ["Shark", "Dolphin", "Clownfish", "Goldfish", "Piranha", "Manta Ray", "Whale", "Octopus", "Squid", "Jellyfish"],
          "insects": ["Butterfly", "Bee", "Ant", "Spider", "Dragonfly", "Ladybug", "Grasshopper", "Beetle", "Mosquito", "Fly"],
          "others": ["Hedgehog", "Squirrel", "Bat", "Frog", "Toad", "Salamander", "Newt"]
        }
        EOF
        
        cat > data/used_animals.json << 'EOF'
        []
        EOF
        
        cat > data/performance_data.json << 'EOF'
        {
          "upload_history": [],
          "content_strategy": {
            "successful_animals": [],
            "top_keywords": [],
            "optimal_video_length": 300,
            "best_upload_times": ["12:00", "18:00", "20:00"]
          }
        }
        EOF
        
    - name: Run YouTube Automation with Real Upload
      id: automation
      env:
        YT_CLIENT_ID: ${{ secrets.YT_CLIENT_ID }}
        YT_CLIENT_SECRET: ${{ secrets.YT_CLIENT_SECRET }}
        YT_REFRESH_TOKEN: ${{ secrets.YT_REFRESH_TOKEN }}
        YT_CHANNEL_ID: ${{ secrets.YT_CHANNEL_ID }}
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        ELEVEN_API_KEY: ${{ secrets.ELEVEN_API_KEY }}
        PEXELS_API_KEY: ${{ secrets.PEXELS_API_KEY }}
        UPLOAD_MODE: ${{ github.event.inputs.upload_type }}
      run: |
        echo "ğŸ¯ ÙˆØ¶Ø¹ Ø§Ù„ØªØ´ØºÙŠÙ„: $UPLOAD_MODE"
        if [ "$UPLOAD_MODE" = "real" ]; then
          echo "ğŸš€ Ø¨Ø¯Ø¡ Ø§Ù„Ø±ÙØ¹ Ø§Ù„ÙØ¹Ù„ÙŠ Ø¹Ù„Ù‰ Ø§Ù„ÙŠÙˆØªÙŠÙˆØ¨..."
          python scripts/main.py --real-upload --daily-run
          
          # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª Ù…Ø±ÙÙˆØ¹Ø© ÙØ¹Ù„ÙŠØ§Ù‹
          if grep -q "ğŸ‰ ØªÙ… Ø±ÙØ¹ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø¨Ù†Ø¬Ø§Ø­ Ø¹Ù„Ù‰ Ø§Ù„ÙŠÙˆØªÙŠÙˆØ¨" logs/automation.log; then
            echo "ğŸ‰ ØªÙ… Ø§Ù„Ø±ÙØ¹ Ø§Ù„ÙØ¹Ù„ÙŠ Ø¹Ù„Ù‰ Ø§Ù„ÙŠÙˆØªÙŠÙˆØ¨ Ø¨Ù†Ø¬Ø§Ø­!"
            echo "success=true" >> $GITHUB_OUTPUT
          else
            echo "âŒ ÙØ´Ù„ Ø§Ù„Ø±ÙØ¹ Ø¹Ù„Ù‰ Ø§Ù„ÙŠÙˆØªÙŠÙˆØ¨ - Ù„Ù… ÙŠØªÙ… Ø±ÙØ¹ Ø£ÙŠ ÙÙŠØ¯ÙŠÙˆ"
            echo "success=false" >> $GITHUB_OUTPUT
            exit 1
          fi
        else
          echo "ğŸ§ª ÙˆØ¶Ø¹ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±..."
          python scripts/main.py --test-run
          echo "success=true" >> $GITHUB_OUTPUT
        fi
        
    - name: Show YouTube Upload Results
      if: always()
      run: |
        echo "=== Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø±ÙØ¹ Ø¹Ù„Ù‰ Ø§Ù„ÙŠÙˆØªÙŠÙˆØ¨ ==="
        if [ -f "logs/automation.log" ]; then
          echo "ğŸ“‹ Ø³Ø¬Ù„ Ø§Ù„Ø±ÙØ¹ Ø§Ù„Ù†Ø§Ø¬Ø­:"
          grep -E "(ğŸ‰ ØªÙ… Ø±ÙØ¹ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø¨Ù†Ø¬Ø§Ø­ Ø¹Ù„Ù‰ Ø§Ù„ÙŠÙˆØªÙŠÙˆØ¨|ğŸ”— Ø§Ù„Ø±Ø§Ø¨Ø·: https://youtube.com)" logs/automation.log || echo "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª Ø±ÙØ¹ Ù†Ø§Ø¬Ø­Ø©"
          echo ""
          echo "ğŸ¯ Ù…Ù„Ø®Øµ Ø§Ù„Ø±ÙØ¹:"
          grep -E "(ğŸ‰ Ø§ÙƒØªÙ…Ù„Øª Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­|âŒ ÙØ´Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©)" logs/automation.log || echo "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ù„Ø®Øµ"
        else
          echo "âŒ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø³Ø¬Ù„ ØªÙ†ÙÙŠØ°"
        fi
        
    - name: Upload execution results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: youtube-automation-results-${{ github.run_id }}
        path: |
          logs/
          outputs/
        retention-days: 3
