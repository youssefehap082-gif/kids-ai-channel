name: Daily YouTube Automation

on:
  schedule:
    - cron: '0 12 * * *'  # يومياً الساعة 12 ظهراً UTC
  workflow_dispatch:  # تشغيل يدوي

jobs:
  generate-and-upload:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y ffmpeg
        sudo apt-get install -y python3-pip
        sudo apt-get install -y libimage-exiftool-perl
        python -m pip install --upgrade pip
        
    - name: Install Python dependencies
      run: |
        pip install -r requirements.txt
        # تثبيت إصدار متوافق من moviepy إذا كانت هناك مشاكل
        pip install moviepy --upgrade
        pip install pillow --upgrade
        
    - name: Create necessary directories
      run: |
        mkdir -p logs outputs/videos outputs/shorts outputs/temp data assets/music
        mkdir -p scripts
        
    - name: Create basic data files
      run: |
        cat > data/animal_database.json << 'EOF'
        {
          "mammals": ["Lion", "Elephant", "Tiger", "Giraffe", "Wolf", "Bear", "Kangaroo", "Panda", "Zebra", "Fox", "Deer", "Horse", "Donkey", "Rabbit", "Raccoon"],
          "reptiles": ["Cobra", "Python", "Chameleon", "Komodo Dragon", "Alligator", "Turtle", "Crocodile", "Iguana", "Gecko", "Snake"],
          "birds": ["Eagle", "Parrot", "Penguin", "Owl", "Flamingo", "Peacock", "Hawk", "Swan", "Pigeon", "Sparrow"],
          "fish": ["Shark", "Dolphin", "Clownfish", "Goldfish", "Piranha", "Manta Ray", "Whale", "Octopus", "Squid", "Jellyfish"],
          "insects": ["Butterfly", "Bee", "Ant", "Spider", "Dragonfly", "Ladybug", "Grasshopper", "Beetle", "Mosquito", "Fly"],
          "others": ["Hedgehog", "Squirrel", "Bat", "Frog", "Toad", "Salamander", "Newt"]
        }
        EOF
        
        cat > data/used_animals.json << 'EOF'
        []
        EOF
        
        cat > data/performance_data.json << 'EOF'
        {
          "upload_history": [],
          "content_strategy": {
            "successful_animals": [],
            "top_keywords": [],
            "optimal_video_length": 300,
            "best_upload_times": ["12:00", "18:00", "20:00"]
          }
        }
        EOF
        
    - name: Run automation system
      env:
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        ELEVEN_API_KEY: ${{ secrets.ELEVEN_API_KEY }}
        PEXELS_API_KEY: ${{ secrets.PEXELS_API_KEY }}
        PIXABAY_API_KEY: ${{ secrets.PIXABAY_API_KEY }}
        YT_CLIENT_ID: ${{ secrets.YT_CLIENT_ID }}
        YT_CLIENT_SECRET: ${{ secrets.YT_CLIENT_SECRET }}
        YT_REFRESH_TOKEN: ${{ secrets.YT_REFRESH_TOKEN }}
        YT_CHANNEL_ID: ${{ secrets.YT_CHANNEL_ID }}
        HF_API_TOKEN: ${{ secrets.HF_API_TOKEN }}
        CLOUDINARY_API_KEY: ${{ secrets.CLOUDINARY_API_KEY }}
        TEST_MODE: "true"
      run: |
        python scripts/main.py --test-run
        
    - name: Show logs
      if: always()
      run: |
        echo "=== Log File Contents ==="
        cat logs/automation.log || echo "No log file found"
        echo "=== Output Directory ==="
        ls -la outputs/ || echo "No outputs directory"
        ls -la outputs/videos/ || echo "No videos directory"
        ls -la outputs/shorts/ || echo "No shorts directory"
        
    - name: Upload logs and outputs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: automation-results
        path: |
          logs/
          outputs/
        retention-days: 1
