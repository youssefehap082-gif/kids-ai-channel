# المسار: .github/workflows/main.yml

name: Daily YouTube Content Factory

on:
  workflow_dispatch:  # ده عشان تشغله يدوي (Test Run)
    inputs:
      is_test_run:
        description: 'Run in test mode? (Uploads 1 video immediately)'
        required: true
        default: 'true'
        type: boolean
  
  schedule:
    # هيشتغل كل يوم الساعة 12:00 بتوقيت UTC
    # ده وقت مناسب لاستهداف الجمهور الأمريكي (الصبح بدري)
    - cron: '0 12 * * *'

jobs:
  build-and-upload:
    runs-on: ubuntu-latest
    
    steps:
    - name: 1. Checkout Code
      uses: actions/checkout@v4
      with:
        # لازم نجيب الـ repo كله عشان نقرأ ونكتب ملف used_animals.txt
        fetch-depth: 0 

    - name: 2. Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: 3. Install FFmpeg (أساسي لـ MoviePy)
      run: |
        sudo apt-get update
        sudo apt-get install -y ffmpeg

    - name: 4. Install Dependencies
      run: |
        pip install -r requirements.txt

    - name: 5. Run the Magic (تشغيل المايسترو)
      env:
        # هنا بنمرر كل الـ Secrets للكود بتاعنا
        CLOUDINARY_API_KEY: ${{ secrets.CLOUDINARY_API_KEY }}
        COVERR_API_KEY: ${{ secrets.COVERR_API_KEY }}
        ELEVEN_API_KEY: ${{ secrets.ELEVEN_API_KEY }}
        HF_API_TOKEN: ${{ secrets.HF_API_TOKEN }}
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        PEXELS_API_KEY: ${{ secrets.PEXELS_API_KEY }}
        PIXABAY_API_KEY: ${{ secrets.PIXABAY_API_KEY }}
        REPLICATE_API_TOKEN: ${{ secrets.REPLICATE_API_TOKEN }}
        STORYBLOCKS_API_KEY: ${{ secrets.STORYBLOCKS_API_KEY }}
        VECTEEZY_API_KEY: ${{ secrets.VECTEEZY_API_KEY }}
        YT_CHANNEL_ID: ${{ secrets.YT_CHANNEL_ID }}
        YT_CLIENT_ID: ${{ secrets.YT_CLIENT_ID }}
        YT_CLIENT_SECRET: ${{ secrets.YT_CLIENT_SECRET }}
        YT_REFRESH_TOKEN: ${{ secrets.YT_REFRESH_TOKEN }}
        
        # بنعرف الكود إذا كان ده "Test Run" ولا شغل مجدول
        IS_TEST_RUN: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.is_test_run == 'true' }}

      run: |
        python src/main.py

    - name: 6. Commit State File (تحديث قائمة الحيوانات)
      run: |
        git config --global user.name 'GitHub Actions Bot'
        git config --global user.email 'actions@github.com'
        git add used_animals.txt
        # لو مفيش تغيير، الأمر ده هيفشل بهدوء
        git commit -m "MAINT: Update used animals list" || exit 0
        git push
